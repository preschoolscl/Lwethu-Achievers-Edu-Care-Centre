name: Generate Gallery JSON

on:
  push:
    paths:
      - "gallery/images/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate images.json
        run: |
          mkdir -p gallery            # ensure folder exists
          mkdir -p gallery/images     # ensure images folder exists

          # Start JSON array
          echo "[" > gallery/images.json

          # Loop through all valid image files
          for f in gallery/images/*.{jpg,jpeg,png,gif}; do
            [ -e "$f" ] || continue

            filename=$(basename "$f")
            thumb="thumb-$filename"

            # Add entry to JSON
            echo "  {" >> gallery/images.json
            echo "    \"thumb\": \"images/$thumb\"," >> gallery/images.json
            echo "    \"full\": \"images/$filename\"" >> gallery/images.json
            echo "  }," >> gallery/images.json
          done

          # Remove last comma
          sed -i '$ s/,$//' gallery/images.json

          # Close JSON array
          echo "]" >> gallery/images.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add gallery/images.json
          git commit -m "Auto-generate images.json" || exit 0
          git push
